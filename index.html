<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Image Toy</title>
    <style>
        input{
            width: 800px;
        }
        button{
            background-color: green;
            color: white;
            width: 300px;
            height: 90px;
            border: 3px outset #CCC;
            border-radius: 5px;
        }
    </style>
</head>
<body>
	<h1>Image Toy</h1>
    <canvas width="1024" height="1024"></canvas>
    <div class="controls">
        <p>Write functions to calculate the RGB of each pixel</p>
        <p>Your function has access to the following:
            <ul>
                <li>x</li>
                <li>y</li>
                <li>w (=1024)</li>
                <li>h (=1024)</li>
                <li>TAU (=PI*2)</li>
                <li>sq() (=returns square of number)</li>
                <li>t (=# of frames that have been run</li>
                <li>Any method or property of Math, without needing the Math namespace</li>
            </ul>
            Each function should return a number between 0 and 255.
        </p>
        <p>
            Function for red: <input class="red" value="if(!(x%73)){return 255}else if(!(y%73)){return 255}else{return 0}" />
        </p>
        <p>
            Function for green: <input class="green" value="if(!(x%127)){return 255}else if(!(y%127)){return 255}else{return 0}" />
        </p>
        <p>
            Function for blue: <input class="blue" value="if(!(x%179)){return 255}else if(!(y%179)){return 255}else{return 0}" />
        </p>
        <button class="run">Run</button>
    </div>
    <script>
        var E = Math.E;
        var LN10 = Math.LN10;
        var LN2 = Math.LN2;
        var LOG10E = Math.LOG10E;
        var PI = Math.PI;
        var TAU = Math.PI * 2;
        var SQRT1_2 = Math.SQRT1_2;
        var SQRT2 = Math.SQRT2;
        var abs = Math.abs;
        var acos = Math.acos;
        var asin = Math.asin;
        var atan = Math.atan;
        var atan2 = Math.atan2;
        var ceil = Math.ceil;
        var cos = Math.cos;
        var exp = Math.exp;
        var floor = Math.floor;
        var log = Math.log;
        var max = Math.max;
        var min = Math.min;
        var pow = Math.pow;
        var sq = function(x){ return x * x; };
        var random = Math.random;
        var round = Math.round;
        var sin = Math.sin;
        var sqrt = Math.sqrt;
        var tan = Math.tan;
        var w = 1024;
        var h = 1024;
        var ca = qs('canvas');
        var cx = ca.getContext('2d');
        var ci = cx.getImageData(0,0,w,h);
        var cd = ci.data;

        function qs(sel){
            return document.body.querySelector(sel);
        };

        function setHash(r,g,b){
            var sep = 'ðŸ’‹';
            location.hash = '#' + encodeURIComponent(r + sep + g + sep + b);
        }

        var lastHash = '';

        function parseHash(){
            if (location.hash && location.hash !== lastHash){
                lastHash = location.hash;
                var code = decodeURIComponent(location.hash.slice(1)).split('ðŸ’‹');
                if (code.length === 3){
                    qs('.red').value = code[0];
                    qs('.green').value = code[1];
                    qs('.blue').value = code[2];
                }
            }
        }

        function onRun(evt){
            console.log('running');
            var redText = qs('.red').value;
            var redFunc = new Function('x,y,t',redText);
            var greenText = qs('.green').value;
            var greenFunc = new Function('x,y,t',greenText);
            var blueText = qs('.blue').value;
            var blueFunc = new Function('x,y,t',blueText);
            setHash(redText, greenText, blueText);
            var red, green, blue, idx;
            var alpha = 255;
            var t = 0;
            for (var y = 0; y < h; y++){
                for (var x = 0; x < w; x++){
                    red = redFunc(x,y,t);
                    green = greenFunc(x,y,t);
                    blue = blueFunc(x,y,t);
                    idx = y * w * 4 + x * 4;
                    cd[idx] = red;
                    cd[idx+1] = green;
                    cd[idx+2] = blue;
                    cd[idx+3] = alpha;
                }
            }
            cx.putImageData(ci,0,0);
        }
        parseHash();
        qs('.run').addEventListener('click', onRun, false);
        onRun();
    </script>
</body>
</html>
