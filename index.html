<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Image Toy</title>
    <style>
        input{
            width: 800px;
        }
        button{
            background-color: green;
            color: white;
            width: 300px;
            height: 90px;
            border: 3px outset #CCC;
            border-radius: 5px;
        }
        canvas{
            position: absolute;
            left: 300px;
        }
        .controls{
            position: absolute;
            left: 0;
            width: 300px;
        }
    </style>
</head>
<body>
	<h1>Image Toy</h1>
    <canvas width="256" height="256"></canvas>
    <div class="controls">
        <p>Write functions to calculate the RGB of each pixel</p>
        <p>Your function has access to the following:
            <ul>
                <li>x</li>
                <li>y</li>
                <li>w (=256)</li>
                <li>h (=256)</li>
                <li>TAU (=PI*2)</li>
                <li>sq(n) (returns square of n)</li>
                <li>n2(x,y) (returns 2D noise)</li>
                <li>n3(x,y,z) (returns 3D noise)</li>
                <li>n4(x,y,z,w) (returns 4D noise)</li>
                <li>t (=# of frames that have been run</li>
                <li>Any method or property of Math, without needing the Math namespace</li>
            </ul>
            Each function should return a number between 0 and 255.
        </p>
        <p>
            Function for red: <input class="red" value="if(!(x % 73)){return 255}else if(!(y%73)){return 255}else{return 0}" />
        </p>
        <p>
            Function for green: <input class="green" value="if(!(x % 127)){return 255}else if(!(y%127)){return 255}else{return 0}" />
        </p>
        <p>
            Function for blue: <input class="blue" value="if(!(x % 179)){return 255}else if(!(y%179)){return 255}else{return 0}"/>
        </p>
        <button class="run">Run</button>
        <ul>
            Examples
            <li><a href="#return%20cos%28x%2F%28PI*8%29%29%20*%20255%3B%F0%9F%92%8Breturn%20cos%28y%2F%28PI*8%29%29%20*%20255%3B%F0%9F%92%8Breturn%20%28%20cos%28x%2F%28PI%20*%204%29%29%20%2B%20sin%28y%2F%28PI*4%29%29%20%2B%202%29%20*%2064">Blur-o-vision</a></li>
            <li><a href="#return%20n2%28y%2F50%2Cx%2F50%29%20*%20255%F0%9F%92%8Breturn%20n2%28x%2F100%2Cy%2F100%29%20*%20255%F0%9F%92%8Breturn%20%28%20cos%28x%2F%28PI%20*%204%29%29%20%2B%20sin%28y%2F%28PI*4%29%29%20%2B%202%29%20*%2064">Noise</a></li>
            <li><a href="#return%20n3(y%2F100%2Cx%2F100%2C20*n3(y%2F359%2Cx%2F359%2Ct%2F50))%20*%20255%F0%9F%92%8Breturn%20n3(y%2F100%2Cx%2F100%2C20*n3(y%2F479%2Cx%2F479%2Ct%2F50))%20*%20255%F0%9F%92%8Breturn%20n3(y%2F100%2Cx%2F100%2C20*n3(y%2F613%2Cx%2F613%2Ct%2F50))%20*%20255">Animated Noise</a></li>
        </ul>
    </div>
    <script src="simplex.js"></script><!-- noise implementation -->
    <script>
        var E = Math.E;
        var LN10 = Math.LN10;
        var LN2 = Math.LN2;
        var LOG10E = Math.LOG10E;
        var PI = Math.PI;
        var TAU = Math.PI * 2;
        var SQRT1_2 = Math.SQRT1_2;
        var SQRT2 = Math.SQRT2;
        var abs = Math.abs;
        var acos = Math.acos;
        var asin = Math.asin;
        var atan = Math.atan;
        var atan2 = Math.atan2;
        var ceil = Math.ceil;
        var cos = Math.cos;
        var exp = Math.exp;
        var floor = Math.floor;
        var log = Math.log;
        var max = Math.max;
        var min = Math.min;
        var pow = Math.pow;
        var sq = function(x){ return x * x; };
        var random = Math.random;
        var round = Math.round;
        var sin = Math.sin;
        var sqrt = Math.sqrt;
        var tan = Math.tan;
        var w = 256;
        var h = 256;
        var ca = qs('canvas');
        var cx = ca.getContext('2d');
        var ci = cx.getImageData(0,0,w,h);
        var cd = ci.data;
        var simplex = new SimplexNoise();
        var n2 = function(x,y){ return simplex.noise(x,y); }
        var n3 = function(x,y,z){ return simplex.noise3d(x,y,z); }
        var n4 = function(x,y,z,w){ return simplex.noise4d(x,y,z,w); }

        function qs(sel){
            return document.body.querySelector(sel);
        };

        function setHash(r,g,b){
            var sep = 'ðŸ’‹';
            location.hash = '#' + encodeURIComponent(r + sep + g + sep + b);
        }

        var lastHash = '';

        function parseHash(){
            if (location.hash && location.hash !== lastHash){
                lastHash = location.hash;
                var code = decodeURIComponent(location.hash.slice(1)).split('ðŸ’‹');
                if (code.length === 3){
                    qs('.red').value = code[0];
                    qs('.green').value = code[1];
                    qs('.blue').value = code[2];
                }
            }
        }

        function onRun(evt){
            console.log('running');
            var redText = qs('.red').value;
            var redFunc = new Function('x,y,t',redText);
            var greenText = qs('.green').value;
            var greenFunc = new Function('x,y,t',greenText);
            var blueText = qs('.blue').value;
            var blueFunc = new Function('x,y,t',blueText);
            setHash(redText, greenText, blueText);
            var red, green, blue, idx;
            var alpha = 255;
            var t = 0;
            function eachFrame(){
                t++;
                for (var y = 0; y < h; y++){
                    for (var x = 0; x < w; x++){
                        red = redFunc(x,y,t);
                        green = greenFunc(x,y,t);
                        blue = blueFunc(x,y,t);
                        idx = y * w * 4 + x * 4;
                        cd[idx] = red;
                        cd[idx+1] = green;
                        cd[idx+2] = blue;
                        cd[idx+3] = alpha;
                    }
                }
                cx.putImageData(ci,0,0);
                requestAnimationFrame(eachFrame);
            }
            eachFrame();
        }
        parseHash();
        qs('.run').addEventListener('click', onRun, false);
    </script>
</body>
</html>
